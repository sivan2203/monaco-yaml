{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://your-company.ru/schemas/sber-gateway-config-v1.json",
  "title": "Sber Gateway Sidecar Configuration",
  "description": "Конфигурация sidecar'ов и мониторинга для шлюза Citrix / API Gateway (Sber internal)",
  "markdownDescription": "Конфигурация sidecar'ов и мониторинга для шлюза **Citrix / API Gateway** (Sber internal)\n\n### Пример полного конфига:\n\n```yaml\ncn:\n  enabled: true\n  whitelist: true\n  whitelist_list:\n    - CI1234567890-CLIENT\n\ndynatrace:\n  enabled: true\n  reflex-host: reflex.sberift.ru\n  cluster_name: my-openshift-project\n  env_name: prod\n\nfluentbit:\n  enabled: true\n  kafka-brokers:\n    - broker1.kafka.sberift.ru:9092\n  topic: gateway-access-logs\n  cpu:\n    limits: 200m\n  memory:\n    limits: 256Mi\n\nott:\n  params:\n    enabled: true\n    cpu:\n      limits: 100m\n    memory:\n      limits: 128Mi\n\nrate-limits:\n  enabled: false\n```\n\n> Блоки с `enabled: false` будут скрыты в редакторе и отображены в боковой панели.",
  "type": "object",
  "properties": {
    "cn": {
      "type": "object",
      "description": "Настройки фильтрации входящих соединений по CN сертификата клиента",
      "markdownDescription": "Настройки фильтрации входящих соединений по **CN сертификата** клиента\n\n### Пример:\n\n```yaml\ncn:\n  enabled: true\n  whitelist: true\n  whitelist_list:\n    - CI1234567890-CLIENT\n    - CI0987654321-SERVER-CLIENT\n```\n\n> При `whitelist: true` пропускаются **только** CN из списка. При `false` — блокируются только указанные.",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Включён ли фильтр по CN сертификата клиента"
        },
        "whitelist": {
          "type": "boolean",
          "default": false,
          "description": "true = пропускать только из списка, false = блокировать только из списка"
        },
        "whitelist_list": {
          "type": "array",
          "title": "whitelist",
          "description": "Список разрешённых CN сертификатов (или их частей)",
          "items": {
            "type": "string",
            "pattern": "^[A-Z0-9]{10,}-(CLIENT|SERVER-CLIENT)$",
            "description": "Ожидаемый формат: CIxxxxxxxxxx-CLIENT или CIxxxxxxxxxx-SERVER-CLIENT"
          },
          "minItems": 0,
          "uniqueItems": true
        }
      },
      "required": ["enabled", "whitelist"],
      "additionalProperties": false
    },

    "dynatrace": {
      "type": "object",
      "description": "Настройки интеграции с Dynatrace (OneAgent / ActiveGate sidecar)",
      "markdownDescription": "Настройки интеграции с **Dynatrace** (OneAgent / ActiveGate sidecar)\n\n### Пример:\n\n```yaml\ndynatrace:\n  enabled: true\n  reflex-host: reflex.sberift.ru\n  cluster_name: my-openshift-project\n  env_name: prod\n  reflex_labels: team=gateway,service=api\n```\n\n> При `enabled: true` обязательны поля: `reflex-host`, `cluster_name`, `env_name`.",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Включать ли Dynatrace sidecar в под"
        },
        "reflex-host": {
          "type": "string",
          "format": "hostname",
          "description": "Хостнейм или адрес reflex-сервера Dynatrace",
          "examples": ["reflex.sberift.ru", "reflex.delta.sbrf.ru"]
        },
        "cluster_name": {
          "type": "string",
          "minLength": 8,
          "maxLength": 64,
          "description": "Имя кластера в Dynatrace (обычно совпадает с Openshift проектом)"
        },
        "env_name": {
          "type": "string",
          "enum": ["sberift", "delta", "ift", "prod", "test", "dev"],
          "description": "Код среды (окружения)"
        },
        "reflex_labels": {
          "type": "string",
          "description": "Дополнительные лейблы, передаваемые в Dynatrace (строка)"
        }
      },
      "required": ["enabled"],
      "if": {
        "properties": { "enabled": { "const": true } }
      },
      "then": {
        "required": ["reflex-host", "cluster_name", "env_name"]
      }
    },

    "fluentbit": {
      "type": "object",
      "description": "Настройки Fluent Bit sidecar для отправки логов в Kafka",
      "markdownDescription": "Настройки **Fluent Bit** sidecar для отправки логов в **Kafka**\n\n### Пример:\n\n```yaml\nfluentbit:\n  enabled: true\n  kafka-brokers:\n    - broker1.kafka.sberift.ru:9092\n    - broker2.kafka.sberift.ru:9092\n  topic: gateway-access-logs\n  cpu:\n    limits: 200m\n  memory:\n    limits: 256Mi\n  liveness-probe:\n    initial_delay_seconds: 30\n  readiness-probe:\n    initial_delay_seconds: 15\n```",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": true,
          "description": "Включён ли fluent-bit sidecar"
        },
        "kafka-brokers": {
          "type": "array",
          "description": "Список kafka-брокеров (host:port)",
          "items": {
            "type": "string",
            "pattern": "^[a-z0-9.-]+\\.[a-z0-9.-]+\\.[a-z]+:[0-9]{4,5}$"
          },
          "minItems": 1
        },
        "cpu": {
          "type": "object",
          "properties": {
            "limits": {
              "type": "string",
              "pattern": "^[0-9]+m$",
              "description": "Лимит CPU в milliCPU"
            }
          }
        },
        "memory": {
          "type": "object",
          "properties": {
            "limits": {
              "type": "string",
              "pattern": "^[0-9]+(Mi|Gi)$",
              "description": "Лимит памяти (Mi или Gi)"
            }
          }
        },
        "liveness-probe": {
          "type": "object",
          "properties": {
            "initial_delay_seconds": {
              "type": "integer",
              "minimum": 10,
              "maximum": 300,
              "description": "Задержка перед первой проверкой liveness"
            }
          }
        },
        "readiness-probe": {
          "type": "object",
          "properties": {
            "initial_delay_seconds": {
              "type": "integer",
              "minimum": 10,
              "maximum": 300
            }
          }
        },
        "topic": {
          "type": "string",
          "minLength": 3,
          "maxLength": 128,
          "description": "Имя топика в Kafka для отправки логов"
        }
      },
      "required": ["enabled"]
    },

    "ott": {
      "type": "object",
      "description": "Настройки OTT sidecar (One-time token / short-lived token service)",
      "markdownDescription": "Настройки **OTT** sidecar (One-time token / short-lived token service)\n\n### Пример:\n\n```yaml\nott:\n  params:\n    enabled: true\n    cpu:\n      limits: 100m\n    memory:\n      limits: 128Mi\n```",
      "properties": {
        "params": {
          "type": "object",
          "properties": {
            "enabled": {
              "type": "boolean",
              "description": "Включён ли OTT sidecar"
            },
            "cpu": {
              "type": "object",
              "properties": {
                "limits": {
                  "type": "string",
                  "pattern": "^[0-9]+m$"
                }
              }
            },
            "memory": {
              "type": "object",
              "properties": {
                "limits": {
                  "type": "string",
                  "pattern": "^[0-9]+Mi$"
                }
              }
            }
          }
        }
      }
    },

    "rate-limits": {
      "type": "object",
      "description": "Настройки ограничения скорости запросов (rate limiting)",
      "markdownDescription": "Настройки ограничения скорости запросов (**rate limiting**)\n\n### Пример:\n\n```yaml\nrate-limits:\n  enabled: true\n```",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Включён ли модуль rate limiting"
        }
      }
    }
  },

  "additionalProperties": true,
  "required": []
}
